<apex:component controller="OrderLineItemController">
  <apex:attribute name="orderid" required="true" type="String" description="Order Id"/>

<html>
<head>
    <meta charset="UTF-8" />
    <title>Order Line Item</title>
    
    <apex:stylesheet value="{!URLFOR($Resource.treeviewGrid2983, 'css/easyui.css')}"/>    
    <apex:includeScript value="{!URLFOR($Resource.treeviewGrid2983, 'jquery.min.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.treeviewGrid2983, 'jquery.easyui.min.js')}" /> 
    <apex:includeScript value="/support/console/28.0/integration.js"/>
    
    <style>
    #filterAssetId::-webkit-input-placeholder { /* WebKit browsers */
            font-style: italic;
        }
        #filterAssetId:-moz-placeholder { /* Mozilla Firefox 4 to 18 */
            font-style: italic;
        }
        #filterAssetId::-moz-placeholder { /* Mozilla Firefox 19+ */
            font-style: italic;
        }
        #filterAssetId:-ms-input-placeholder { /* Internet Explorer 10+ */
            font-style: italic;
        }
    .popup-class {        
            display: none; 
            position: absolute; 
            background-color: white; 
            border: 2px solid grey; 
            border-radius: 10px;
            border-top: 5px;
            padding-bottom: 10px;
        }
        .popup-top-border {
            border-top: 3px solid;
            border-left: 0px;
            border-right: 0px;
            border-bottom: 0px;
            border-color: #236FBD;
            border-radius: 10px;
            width: 98%;
            margin-left: 4px;
        }
        .arrow-left {
            width: 0; 
            height: 0;
            display: none; 
            border-top: 15px solid transparent;
            border-bottom: 15px solid transparent; 
            border-right:20px solid grey; 
            position: absolute;
        }
        .arrow-left-inner {
            width: 0; 
            height: 0; 
            display: none; 
            border-top: 15px solid transparent;
            border-bottom: 15px solid transparent;             
            border-right:20px solid white; 
            position: absolute;
        }
        
        .img-wrap {
            position: relative;
            display: inline-block;
         
            font-size: 0;
        }
        .img-wrap .close {
            position: absolute;
            top: -28px;
            right: -90px;
            z-index: 100;
            background-color: #FFF;
            padding: 5px 2px 2px;
            color: #720B00;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            font-size: 22px;
            line-height: 10px;
            border-radius: 50%;
        }
        .img-wrap .close2 {
            position: absolute;
            top: -2px;
            right: -0px;
            z-index: 100;
            background-color: #FFF;
            padding: 5px 2px 2px;
            color: #720B00;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            font-size: 22px;
            line-height: 10px;
            border-radius: 50%;
        }
    .arrow-up {
            width: 0; 
            height: 0;
            display: none; 
            border-left: 15px solid transparent;
            border-right: 15px solid transparent; 
            border-bottom:20px solid grey; 
            position: absolute;
        }
        .arrow-up-inner {
            width: 0; 
            height: 0; 
            display: none; 
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;             
            border-bottom:20px solid white; 
            position: absolute;
        }
        
        .arrow-down {
            width: 0; 
            height: 0;
            display: none; 
            border-left: 15px solid transparent;
            border-right: 15px solid transparent; 
            border-top:20px solid grey; 
            position: absolute;
        }
        .arrow-down-inner {
            width: 0; 
            height: 0; 
            display: none; 
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;             
            border-top:20px solid white; 
            position: absolute;
        }
        /*.datagrid-sort-icon
        {
            width: 11px;
            height: 11px;
            background: transparent url(/img/alohaSkin/sortArrows_sprite.png) !important;
        }
       .datagrid-sort-desc { background-position: 0px -12px; !important}
        .datagrid-sort-asc { background-position: 0px 0px; !important}*/
        .datagrid-cell {
            white-space: normal;
            padding: 5px;
        }
        a {
            text-decoration: none !important;
        }
        a:hover {
            text-decoration: underline !important;
        }
        div.popupLabel {
            padding-left: 20px;
            display: inline-block;
            width: 40%;
        }
        div.popupLabelBold {
            padding-left: 20px;
            display: inline-block;
            font-weight: bold;
            vertical-align: top;
            width: 30%;
        }
        div.popupValueHalfRight {
            padding-left: 5px;
            display: inline-block;
            text-align: right;
            width: 40%;
        }
        
        div.popupValueHalf {
            padding-left: 2px;
            display: inline-block;
            width: 50%;
        }
        
        div.popupValueFullRight {
            padding-left: 5px;
            display: inline-block;
            text-align: right;
            width: 80%;
        }
        
        div.popupValueFull {
            padding-left: 20px;
            display: inline-block;
            width: 80%;
        }
        
        .popupHeader {
            padding-left: 20px;
            padding-bottom: 5px;
            font-weight: bold;
            display: block;
        }
        .popupHeader2 {
            padding-left: 10px;
            padding-top: 10px;
            font-weight: bold;
            font-size: larger;
            display: block;
        }
        .align-right { text-align: right !important; }
        .highlight { font-weight: bold; }
        .panel-tool, .panel-title, .pagination-info, .tree-icon { display: none; }
        div.panel-header{ display: none; }
        .datagrid-header-row input {display: none;}
        
        .parentRow { background-color: white; } //RGB(197,225,234); }
        .childRow:hover, .parentRow:hover, .normalRow:hover { background-color: RGB(232, 246, 254); }
        .childRow { background-color: RGB(239, 240, 245); }
        .normalRow { background-color: white; }
        .tree-collapsed {background: url({!URLFOR($Resource.AssetSearchImages)}) no-repeat -79px 0px; }
        .tree-expanded {background: url({!URLFOR($Resource.AssetSearchImages)}) no-repeat -101px 0px; }
        .panel-header, .panel-body { border-color: rgb(224, 227, 229) !important; }
        .cpc-folder {
            background: url({!URLFOR($Resource.AssetSearchImages)}) no-repeat 0px -35px; 
            display: inline-block;
            height: 16px;
            width: 20px;
            margin-left: 5px;
            margin-top: -2px;
            margin-bottom: -2px;
        }
        .loading-window {
            background-color: rgba(0, 0, 0, 0.1);
            position: absolute;
            text-align: center;
            vertical-align: middle;
            display: none;
            border: 0px solid grey; 
            border-radius: 10px;
            padding-bottom: 10px;
            z-index: 999;
        }
        .loading-icon {
            height: 100%;
            width: 100%;
            background:url('{!URLFOR($Resource.treeviewGrid2983, 'css/images/loading.gif')}') no-repeat center center;
        }
        .input-wrapper {
            padding: 3px 10px 3px 10px;
            text-align: left; 
            display: inline-block; 
            background-color: RGB(206, 238, 247); 
            width: 99%; border: solid; 
            border-width: 1px; 
            border-color: #E0E0E0
        }
        .datagrid-row-selected{ background-color: RGB(221, 240, 220); }
        .datagrid-row-over{
            background: #E3F3FF;
        }
        .tree-indent, .tree-title {display: none;}
        tr.datagrid-row td {vertical-align: middle;}
        div.datagrid-pager td {vertical-align: middle;}
        
        .asset-link { color: blue; }
        .cancel-popup, .no-migrate-popup{ 
            width: 400px;
            height: 250px;
            background-color: white;
            border: solid black;
            border-width: 1px;
            border-radius: 10px;
            z-index: 999;
            position: absolute;
            margin: auto;
            display: none;
        }
        .cancel-green-wrapper {
            display: block;
            width: 80%;
            height: 80%; 
            position: relative;
            text-align: center;
            margin-left:auto;
            margin-right:auto;
        }
            
        .no-migrate-red-wrapper {
            display: block;
            width: 80%;
            height: 40%; 
            position: relative;
            text-align: center;
            margin-left:auto;
            margin-right:auto;
        }
        .cancel-green-text {
            color: green;
            font-weight: bold;
            font-size: 18px !important;
            display: block;
            clear: right;
            width: 100%;
            text-align: center;
            vertical-align: text-top;
            position: absolute;
            top: 0px;
            padding-top: 55px;
        }
        .cancel-end-wrapper, .no-migrate-end-wrapper {
            width: 80%;
            height: 40%;
            position: relative;
            margin-left:auto;
            margin-right:auto;
        }
        .cancel-end-text {
            display: block;
            text-align: center;
            vertical-align: middle;
            font-weight: bold;
        }
        .cancel-button-wrapper, .no-migrate-button-wrapper {
            width: 100%;            
            height: 20%;
            position: relative;
            vertical-align: middle;
            text-align: center;
        }
        .cancel-button-close, .no-migrate-button-close { 
            width: 120px;
        }

        .no-migrate-red-text {
            color: red;
            font-weight: bold;
            font-size: 18px !important;
            display: block;
            clear: right;
            width: 100%;
            text-align: center;
            vertical-align: text-bottom;
            position: absolute;
            bottom: 0px;
        }
        .mask{
          z-index: 500;
          position: fixed;
          display: none; 
         background: transparent;
         height: 100%;
         width: 100%;
         top: 0px;
         left: 0px;
        }
       .no-migrate-end-text {
           display: block;
           text-align: center;
           vertical-align: middle;
           font-style: italic;
       }
    
    
    </style>
    
    <script type="text/javascript">
            orderL$ = jQuery.noConflict();
            var shippingWinTimeoutIn = new Object();
            var shippingWinTimeoutOut = new Object();
            var filterTimeout;
            var keyupDelay = 500;
            var hoverDelay = 1000;
            var headerOffset = -111;
            var loadingOffset = -10;
            var orderLineItemResult = new Object();
  
  
             function loadOrderLineItemData() {
               // var filterText = orderL$("input[id*='filterAssetId']").val();
                // making js remoting call
                 Visualforce.remoting.Manager.invokeAction(
                '{!$RemoteAction.OrderLineItemController.getOrderLineItems}', "{!orderid}", function(result, event) {
                    if (event.status) {
                        orderLineItemResult = result;
                        orderL$('#orderItemTable').treegrid({  
                            data: result
                        });
                        //orderLineItemResult = result;
                        console.log(result);
                        setShippingLinksAndHighlights();
                    } else if (event.type === 'exception') {    
                         alert(event.message);
                    } else {
                       alert(event.message);
                    }
                }, {escape:true});
            }
            
            // Making initial data load call for tree view creating.
            loadOrderLineItemData();
            
                
        // BTBS- 3314: Hiding required shipping info inside link tag so that it can be retrieved later on for
        // showing shipping popup    
         function formatShippingLink(value, row) {
                if (value) {
                      return '<u><a href="#" data-orderLineId="' + row.externalId + '" data-shipLineMethod="' + row.Ship_Method +
                                '" data-shipLineDate="' + row.Ship_Date + '" data-shipLineCarrier="' + row.Carrier + '" data-shipLineTrackingNo="' + 
                                 row.Tracking_Number + '" onclick="return false;" class="shipping_link" >' + value + '</a></u>';
                      //return '<u data-assetId="' + row.id + '" class="payment_link">' + value + '</u>';
                    }
                }
                
                
         function setShippingLinksAndHighlights() {
                 orderL$(".shipping_link").each(function() {
                    var orderLineId = this.getAttribute('data-orderLineId');
                    
                    orderL$(this).mouseenter(function() {
                        clearTimeout(shippingWinTimeoutIn[orderLineId]);
                        clearTimeout(shippingWinTimeoutOut[orderLineId]);
                        var thisObject = this;
                        shippingWinTimeoutIn[orderLineId] = setTimeout(function() { loadSelectedShipping(orderLineId, thisObject);}, hoverDelay);
                    });
                    orderL$(this).mouseleave(function() {
                        clearTimeout(shippingWinTimeoutIn[orderLineId]);
                        clearTimeout(shippingWinTimeoutOut[orderLineId]);
                        shippingWinTimeoutOut[orderLineId] = setTimeout(function() {closeShippingWindow();}, hoverDelay);
                    });
                });
          resizeView();
          
          } 
          
          function formatProductName(value, row) {
                if (value) {
                    if (row.isParent == true && (row.isChildOdd == false && row.isChildEven == false)) { 
                        return value + '<div class="cpc-folder"></div>';
                    } else if (row.isChildOdd == true || row.isChildEven == true) {
                        return value ;
                    } else { 
                        return value ;
                    }
                }
            }
          
           function styleBackground(row, index) {
                if (row.isChildOdd) return { class:"childRow" };
                else if (row.isParent) return { class:"parentRow" };
                else return { class:"normalRow" };
            }
            
          function pagerFilter(data){
            if (orderL$.isArray(data)){    // is array  
                data = {  
                    total: data.length,  
                    rows: data  
                }  
            }
            var dg = orderL$(this);  
            var state = dg.data('treegrid');
            var opts = dg.treegrid('options');  
            var pager = dg.treegrid('getPager');  
            pager.pagination({  
                onSelectPage:function(pageNum, pageSize){  
                    opts.pageNumber = pageNum;  
                    opts.pageSize = pageSize;  
                    pager.pagination('refresh',{  
                        pageNumber:pageNum,  
                        pageSize:pageSize  
                    });  
                    dg.treegrid('loadData',data); 
                    resizeView();
                    //var filterText = orderL$("input[id*='filterAssetId']").val();
                    //setLinksAndHighlights(filterText); 
                },
                //onBeforeRefresh: filterAssetData  
            });  
            if (!data.topRows){  
                data.topRows = [];
                data.childRows = [];
                for(var i=0; i<data.rows.length; i++){
                        var row = data.rows[i];
                        row._parentId ? data.childRows.push(row) : data.topRows.push(row);
                }
                                data.total = (data.topRows.length);
            }  
            var start = (opts.pageNumber-1)*parseInt(opts.pageSize);  
            var end = start + parseInt(opts.pageSize);  
                        data.rows = orderL$.extend(true,[],data.topRows.slice(start, end).concat(data.childRows));
                        return data;
                }
         
        
      // BTBS-3314: Updated to show the shipping info in shipping popup for CPC child products. Now getting the 
      // required values for querying custom setting 'Order_Shipment_Tracking' from link attributes.
        function loadSelectedShipping(assetId, e){
           openShippingWindow(e, assetId);
           var shipCarrier = e.getAttribute('data-shipLineCarrier');
           var shipDate = e.getAttribute('data-shipLineDate');
           var shipMethod = e.getAttribute('data-shipLineMethod');
           var shipTrackingNo = e.getAttribute('data-shipLineTrackingNo');
               
               // Making remoting call to grab Carrier URL
               Visualforce.remoting.Manager.invokeAction(
                  '{!$RemoteAction.OrderLineItemController.getShippingCarrierURL}', shipCarrier, function(result, event) {
                     if (event.status) {
                        orderL$('#hoveredShipTracking').html('<u><a target="_blank" href =" '+ result[0].URL__c + shipTrackingNo + '">'+
                                                                      shipTrackingNo+ '</a></u>');
                     } else if (event.type === 'exception') {    
                           alert(event.message);
                         } else {
                             alert(event.message);
                           }
                 }, {escape:true});
      
                 document.getElementById('hoveredShipMethod').innerHTML = shipMethod;
                 document.getElementById('hoveredShipDate').innerHTML = (new Date(shipDate)).toDateString();
                 document.getElementById('hoveredShipCarrier').innerHTML = shipCarrier;
             
                if ((orderL$(e).offset().top + orderL$(e).height() + 17 + orderL$("#shipping_win").height()) > orderL$(window).height() - 40) { openShippingWindow(e, assetId); }
                 closeLoadingWindow();
 
        } 
        
         
        
         function resizeView() {                
                if (!orderL$('.datagrid-row:visible').length){
                    var vc = orderL$('#orderItemTable').datagrid('getPanel').children('div.datagrid-view');
                    vc.children('div.datagrid-empty').remove();
                    var d = orderL$('<div class="datagrid-empty"></div>').html('No products and services').appendTo(vc);
                    d.css({
                        position:'absolute',
                        left:0,
                        top:35,
                        width:'100%',
                        textAlign:'left',
                        'padding-left': '10px',
                        'padding-top': '15px'
                    });
                    orderL$('#orderItemTable').treegrid('resize', { height: 110 });
                }
                else{
                    var vc = orderL$('#orderItemTable').datagrid('getPanel').children('div.datagrid-view');
                    vc.children('div.datagrid-empty').remove();
                    var rowHeights = orderL$('.datagrid-header-row').height() + 50; 
                    orderL$('.datagrid-row:visible').each(function() {
                        rowHeights += orderL$(this).height(); 
                    });
                    orderL$('#orderItemTable').treegrid('resize', { height: rowHeights });
                }
            }
        
        
        function openShippingWindow(e, assetId) {
                orderL$("#shipping_win").css({
                        "left": function() {
                            return orderL$(e).offset().left - (orderL$("#shipping_win").width() * .666);
                        },
                        "top": function() {
                            return orderL$(e).offset().top + orderL$(e).height() + 17 + headerOffset;
                        },
                        "display": "block"
                    });
                orderL$("#shipping_arrow_up").css({
                    "left": function() {
                        return orderL$(e).offset().left + (orderL$(e).width() / 2) - 30;
                    },
                    "top": function() {
                                return orderL$(e).offset().top + orderL$(e).height() - 2 + headerOffset;
                            },
                    "display": "block"
                });
                orderL$("#shipping_arrow_up_inner").css({
                    "left": function() {
                        return orderL$(e).offset().left + (orderL$(e).width() / 2) -30;
                    },
                    "top": function() {
                                return orderL$(e).offset().top + orderL$(e).height() + headerOffset;
                            },
                    "display": "block"
                });
                orderL$("#shipping_win").mouseenter(function() {
                        clearTimeout(shippingWinTimeoutOut[assetId]);
                    }).mouseleave(function() {
                        clearTimeout(shippingWinTimeoutOut[assetId]);
                        shippingWinTimeoutOut[assetId] = setTimeout(function() {closeShippingWindow();}, hoverDelay);
                    });
                openLoadingWindow(orderL$("#shipping_win").offset().left, orderL$("#shipping_win").offset().top, (orderL$("#shipping_win").width() + 2), orderL$("#shipping_win").height(), true);
            } 
            
             function styleBackground(row, index) {
                if (row.isChildOdd) return { class:"childRow" };
                else if (row.isParent) return { class:"parentRow" };
                else return { class:"normalRow" };
            }
            
            function openLoadingWindow(x, y, w, h, rounded) {
                orderL$("#loading-window").css({
                    "left": x + loadingOffset,
                    "top": y + headerOffset,
                    "width": w,
                    "height": h,
                    "display": "block",
                    "z-index":999,
                    "border-radius": function() {
                        if (rounded==true) { return "10px"; }
                        else return "0px";
                    }
                });
            }
            
            function closeShippingWindow() {
                orderL$('#shipping_win').css("display","none");
                orderL$("#shipping_arrow_down").css("display","none");
                orderL$("#shipping_arrow_down_inner").css("display","none");
                orderL$("#shipping_arrow_up").css("display","none");
                orderL$("#shipping_arrow_up_inner").css("display","none");
            } 
            
            function clearShippingWindow() {
                document.getElementById('hoveredShipMethod').innerHTML = '&nbsp;';
                document.getElementById('hoveredShipCarrier').innerHTML = '&nbsp;';
                
            }
            
            function closeLoadingWindow() {
                orderL$("#loading-window").css("display", "none");
            }
            
                    
      </script>  
      
    <div style="float: left; clear both; width:100%"> 
    <table id="orderItemTable" title="Order Line Items" class="easyui-treegrid" width="100%" 
               data-options="
                fitColumns: true,
                animate: true,
                collapsible: false,
                idField: 'externalId',
                treeField: 'isCPC',
                loadFilter: pagerFilter,
                pagination: {!isPaginated},
                pageSize: 5,
                pageList: [5,10,20,50,100],
                rowStyler: styleBackground,
                onExpand: resizeView,
                onCollapse: resizeView,
                rownumbers: false,
                singleSelect: true">
        <thead>
           <tr>  
               <th data-options="field:'isCPC', width:8, resizable:true" > </th>   
               <th data-options="field:'Product_Name', formatter:formatProductName, width:60, resizable:true" ><b>Line Item</b> </th>
               <th data-options="field:'Action_Code', width:20,resizable:true" ><b>Action</b> </th>
               <th data-options="field:'Configuration', width:70, resizable:true"><b>Configuration</b></th>
               <th data-options="field:'Quantity', width:20, resizable:true" ><b>Quantity</b> </th>
			   <th data-options="field:'Grant_Id', width:20, resizable:true" ><b>Grant Id</b> </th>
			   <!------------------ BTBS-4100 Added Status Column in Order Line Item table-------------------->
               <th data-options="field:'Status', width:20, resizable:true" ><b>Status</b> </th>
               <th data-options="field:'DISCOUNT_METHOD__c', width:35,  resizable:true" ><b>Discount</b> </th>
               <th data-options="field:'Current_Charge', width:40, resizable:true" ><b>Current Charge</b> </th>
               <th data-options="field:'Ship_Method',formatter:formatShippingLink, width:40, resizable:true"><b>Ship Method</b></th>
                
               
               
           </tr>
        </thead>
    </table>
    </div>
     
     <div id="shipping_win" class="popup-class" style="z-index:998; width:300px">
            <div class="popup-top-border"></div>
            <div style="display: inline-block; width: 100%;">
                <div class="popupHeader2">Shipping Details</div><br /><br />
                <div class="popupLabelBold" >Ship Method: </div><div class="popupValueHalf" id="hoveredShipMethod"></div>
                <div class="popupLabelBold" >Ship Date: </div><div class="popupValueHalf" id="hoveredShipDate"></div>
                <div class="popupLabelBold" >Carrier: </div><div class="popupValueHalf" id="hoveredShipCarrier"></div>
                <div class="popupLabelBold">Tracking #: </div><div class="popupValueHalf" id="hoveredShipTracking"></div><br /><br />
                
               
            </div>
    </div>
    
    <div class="arrow-up" id="shipping_arrow_up"></div>
    <div class="arrow-up-inner" id="shipping_arrow_up_inner"></div>
    <div class="arrow-down" id="shipping_arrow_down"></div>
    <div class="arrow-down-inner" id="shipping_arrow_down_inner"></div>
    
  <!--  <apex:form id="orderFormitem">
    <apex:outputlabel value="No records to display" rendered="{!olishowrelList==False}"/><br/>
            <apex:commandlink id="cmdlnk" value="Show {!olishowcount} more ï¿½ " action="{!showmoreItem}" reRender="orderFormitem, cmdlnk" rendered="{!olishowmoreflag}" style="font-family: Arial,Helvetica,sans-serif;"/>
    </apex:form> -->
    
</head>
</html>
</apex:component>