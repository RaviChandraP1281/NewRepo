<?xml version="1.0" encoding="UTF-8"?>
<CustomObject xmlns="http://soap.sforce.com/2006/04/metadata">
    <validationRules>
        <fullName>Prevent_edit_record_if_email_sent</fullName>
        <active>true</active>
        <description>Agents should not edit a notification if it has already been sent</description>
        <errorConditionFormula>IF(AND(Locked__c == true, OR(ISCHANGED(Email_Template__c),ISCHANGED(Category__c)))  , true, false)</errorConditionFormula>
        <errorMessage>This notification has already been sent. Do not modify the record</errorMessage>
    </validationRules>
    <webLinks>
        <fullName>Send_Email</fullName>
        <availability>online</availability>
        <description>Send mass email that was saved</description>
        <displayType>button</displayType>
        <linkType>javascript</linkType>
        <masterLabel>Send Email</masterLabel>
        <openType>onClickJavaScript</openType>
        <protected>false</protected>
        <url>{!REQUIRESCRIPT(&quot;/soap/ajax/31.0/connection.js&quot;)} 
{!REQUIRESCRIPT(&quot;/soap/ajax/31.0/apex.js&quot;)} 

try{ 

var custNotification = &apos;{!Customer_Notification__c.Id }&apos;; 
var funcName = &quot;SendSavedEmail&quot;; 
var className = &quot;SendEmail&quot;; 
var className2 = &quot;getCount&quot;; 

{!IF(OR(ISPICKVAL(Customer_Notification__c.Status__c, &apos;Email Sent&apos;),ISPICKVAL(Customer_Notification__c.Status__c, &apos;In Progress&apos;)), 
&quot;this.disabled=true;this.className = &apos;btnDisabled&apos;;alert(&apos;Email already sent&apos;);&quot;, 
&quot;var count = sforce.apex.execute(funcName, className2,{custNotificationId: custNotification});if(count == 0) {alert(&apos;There are no cases associated in this category&apos;)} else {if(confirm(&apos;The number of emails you are going to send is &apos; + count)){sforce.apex.execute(funcName, className, {custNotificationId: custNotification});alert(&apos;Your email will be sent&apos;);}} document.location.reload(true);&quot;)} 

} 

catch(err){ 
alert(err); 
}</url>
    </webLinks>
</CustomObject>
